<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0,viewport-fit=cover"><title>riscv-5-设备树 | Sifanのblog</title><meta name="author" content="liangzhou"><meta name="copyright" content="liangzhou"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="1.设备树介绍 参考：  Linux——设备树_linux 设备树-CSDN博客 设备树详解 | TimerのBlog (yanglianoo.github.io)   设备树：是一种描述硬件的数据结构，提供一种语言将硬件配置从Linux内核源码中提取出来，使得目标板和设备变成数据驱动的，它们必须基于传递给内核的数据进行初始化。 设备树文件 使用一种”Device Tree Source”（DTS">
<meta property="og:type" content="article">
<meta property="og:title" content="riscv-5-设备树">
<meta property="og:url" content="http://liangzhouzz.github.io/2024/06/08/riscv-5-%E8%AE%BE%E5%A4%87%E6%A0%91/index.html">
<meta property="og:site_name" content="Sifanのblog">
<meta property="og:description" content="1.设备树介绍 参考：  Linux——设备树_linux 设备树-CSDN博客 设备树详解 | TimerのBlog (yanglianoo.github.io)   设备树：是一种描述硬件的数据结构，提供一种语言将硬件配置从Linux内核源码中提取出来，使得目标板和设备变成数据驱动的，它们必须基于传递给内核的数据进行初始化。 设备树文件 使用一种”Device Tree Source”（DTS">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="http://liangzhouzz.github.io/img/duck.jpg">
<meta property="article:published_time" content="2024-06-08T08:13:59.000Z">
<meta property="article:modified_time" content="2024-06-09T10:26:37.010Z">
<meta property="article:author" content="liangzhou">
<meta property="article:tag" content="操作系统">
<meta property="article:tag" content="riscv，qemu">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://liangzhouzz.github.io/img/duck.jpg"><link rel="shortcut icon" href="/img/duck.jpg"><link rel="canonical" href="http://liangzhouzz.github.io/2024/06/08/riscv-5-%E8%AE%BE%E5%A4%87%E6%A0%91/index.html"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox/fancybox.min.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = {
  root: '/',
  algolia: undefined,
  localSearch: {"path":"/search.xml","preload":false,"top_n_per_article":1,"unescape":false,"languages":{"hits_empty":"找不到您查询的内容：${query}","hits_stats":"共找到 ${hits} 篇文章"}},
  translate: undefined,
  noticeOutdate: undefined,
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  dateSuffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: {"limitCount":50,"languages":{"author":"作者: liangzhou","link":"链接: ","source":"来源: Sifanのblog","info":"著作权归作者所有。商业转载请联系作者获得授权，非商业转载请注明出处。"}},
  lightbox: 'fancybox',
  Snackbar: undefined,
  source: {
    justifiedGallery: {
      js: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery/dist/fjGallery.min.js',
      css: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery/dist/fjGallery.min.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isAnchor: false,
  percent: {
    toc: true,
    rightside: true,
  },
  autoDarkmode: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'riscv-5-设备树',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2024-06-09 18:26:37'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
    win.saveToLocal = {
      set: function setWithExpiry(key, value, ttl) {
        if (ttl === 0) return
        const now = new Date()
        const expiryDay = ttl * 86400000
        const item = {
          value: value,
          expiry: now.getTime() + expiryDay,
        }
        localStorage.setItem(key, JSON.stringify(item))
      },

      get: function getWithExpiry(key) {
        const itemStr = localStorage.getItem(key)

        if (!itemStr) {
          return undefined
        }
        const item = JSON.parse(itemStr)
        const now = new Date()

        if (now.getTime() > item.expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return item.value
      }
    }
  
    win.getScript = url => new Promise((resolve, reject) => {
      const script = document.createElement('script')
      script.src = url
      script.async = true
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    })
  
    win.getCSS = (url,id = false) => new Promise((resolve, reject) => {
      const link = document.createElement('link')
      link.rel = 'stylesheet'
      link.href = url
      if (id) link.id = id
      link.onerror = reject
      link.onload = link.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        link.onload = link.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(link)
    })
  
      win.activateDarkMode = function () {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = function () {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
          if (t === 'dark') activateDarkMode()
          else if (t === 'light') activateLightMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
    const detectApple = () => {
      if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
    })(window)</script><meta name="generator" content="Hexo 6.3.0"></head><body><div id="loading-box"><div class="loading-left-bg"></div><div class="loading-right-bg"></div><div class="spinner-box"><div class="configure-border-1"><div class="configure-core"></div></div><div class="configure-border-2"><div class="configure-core"></div></div><div class="loading-word">加载中...</div></div></div><script>(()=>{
  const $loadingBox = document.getElementById('loading-box')
  const $body = document.body
  const preloader = {
    endLoading: () => {
      $body.style.overflow = ''
      $loadingBox.classList.add('loaded')
    },
    initLoading: () => {
      $body.style.overflow = 'hidden'
      $loadingBox.classList.remove('loaded')
    }
  }

  preloader.initLoading()
  window.addEventListener('load',() => { preloader.endLoading() })

  if (false) {
    document.addEventListener('pjax:send', () => { preloader.initLoading() })
    document.addEventListener('pjax:complete', () => { preloader.endLoading() })
  }
})()</script><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src="/img/duck.jpg" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="sidebar-site-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">35</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">24</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">7</div></a></div><hr class="custom-hr"/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 归档</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> 链接</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url('/img/cloud.jpg')"><nav id="nav"><span id="blog-info"><a href="/" title="Sifanのblog"><span class="site-name">Sifanのblog</span></a></span><div id="menus"><div id="search-button"><a class="site-page social-icon search" href="javascript:void(0);"><i class="fas fa-search fa-fw"></i><span> 搜索</span></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 归档</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> 链接</span></a></div></div><div id="toggle-menu"><a class="site-page" href="javascript:void(0);"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">riscv-5-设备树</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2024-06-08T08:13:59.000Z" title="发表于 2024-06-08 16:13:59">2024-06-08</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2024-06-09T10:26:37.010Z" title="更新于 2024-06-09 18:26:37">2024-06-09</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/riscv/">riscv</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title="riscv-5-设备树"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">阅读量:</span><span id="busuanzi_value_page_pv"><i class="fa-solid fa-spinner fa-spin"></i></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><h1 id="1-设备树介绍"><a href="#1-设备树介绍" class="headerlink" title="1.设备树介绍"></a>1.设备树介绍</h1><blockquote>
<p>参考：</p>
<ol>
<li><a target="_blank" rel="noopener" href="https://blog.csdn.net/qq_52479948/article/details/132127885">Linux——设备树_linux 设备树-CSDN博客</a></li>
<li><a target="_blank" rel="noopener" href="https://yanglianoo.github.io/2023/06/11/%E8%AE%BE%E5%A4%87%E6%A0%91%E8%AF%A6%E8%A7%A3/">设备树详解 | TimerのBlog (yanglianoo.github.io)</a></li>
</ol>
</blockquote>
<p><strong>设备树：</strong>是一种描述硬件的数据结构，提供一种语言将硬件配置从Linux内核源码中提取出来，使得目标板和设备变成数据驱动的，它们必须基于传递给内核的数据进行初始化。</p>
<p>设备树文件 使用一种<code>”Device Tree Source”（DTS）</code>的语言编写，文件描述了硬件设备的层次结构，寄存器地址，中断线路，DMA通道和其他的相关属性。</p>
<p>设备树文件 经过<code>DTC</code>编译后会生成一种称为”Device Tree Blob”（DTB）的二进制格式。DTB文件在引导过程中由引导加载程序（Bootloader）提供给内核。内核会解析DTB文件，根据其中的描述信息初始化硬件设备，并加载相应的驱动程序。</p>
<p>名词解释：</p>
<ul>
<li><code>DTS</code>device tree source ，.dts文件，是一种ASCII 文本格式的文件，一般一个文件对应一个硬件平台</li>
<li><strong><code>DTC</code>：</strong>device tree complier 编译设备树源码的编译工具，一般情况下需要手动安装这个编译工具 </li>
<li><code>DTB</code>：device tree bin 生成的编译文件</li>
</ul>
<p><img src="/2024/06/08/riscv-5-%E8%AE%BE%E5%A4%87%E6%A0%91/image-20240609150607554.png" alt="image-20240609150607554"></p>
<h1 id="2-编写quard-star的设备树文件"><a href="#2-编写quard-star的设备树文件" class="headerlink" title="2.编写quard_star的设备树文件"></a>2.编写quard_star的设备树文件</h1><p>新建dts文件夹和quard_star_sbi.dts</p>
<blockquote>
<p>dts&#x2F;quard_star_sbi.dts</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">#address-cells = &lt;0x2&gt;;</span><br><span class="line">#size-cells = &lt;0x2&gt;;</span><br><span class="line">compatible = &quot;riscv-quard-star&quot;;</span><br><span class="line">model = &quot;riscv-quard-star,qemu&quot;;</span><br><span class="line"></span><br><span class="line">chosen &#123;</span><br><span class="line">	stdout-path = &quot;/soc/uart0@10000000&quot;;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">memory@80000000 &#123;</span><br><span class="line">	device_type = &quot;memory&quot;;</span><br><span class="line">	reg = &lt;0x0 0x80000000 0x0 0x40000000&gt;;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<ul>
<li><strong>compatible属性</strong>：属性值类型：字符串,<ul>
<li>compatible是系统用来决定绑定到设备的设备驱动的关键。 compatible属性是用来查找节点的方法之一，另外还可以通过节点名或节点路径查找指定节点。</li>
</ul>
</li>
<li><strong>model属性</strong>：属性值类型：字符串<ul>
<li>model属性用于指定设备的制造商和型号，推荐使用“制造商, 型号”的格式，当然也可以自定义。</li>
</ul>
</li>
<li><strong>reg属性</strong><ul>
<li>reg属性描述设备资源在其父总线定义的地址空间内的地址。通常情况下用于表示一块内存的起始地址（偏移地址）和长度，</li>
</ul>
</li>
<li><strong>chosen子节点</strong>：chosen子节点位于根节点下，<ul>
<li>chosen子节点不代表实际硬件，它主要用于给内核传递参数。 这里设置了uart0</li>
</ul>
</li>
</ul>
<p>总的代码，定义了CPU uart 中断等</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br></pre></td><td class="code"><pre><span class="line">/dts-v1/;</span><br><span class="line"></span><br><span class="line">/ &#123;</span><br><span class="line">	#address-cells = &lt;0x2&gt;;</span><br><span class="line">	#size-cells = &lt;0x2&gt;;</span><br><span class="line">	compatible = &quot;riscv-quard-star&quot;;</span><br><span class="line">	model = &quot;riscv-quard-star,qemu&quot;;</span><br><span class="line"></span><br><span class="line">	chosen &#123;</span><br><span class="line">		stdout-path = &quot;/soc/uart0@10000000&quot;;</span><br><span class="line">	&#125;;</span><br><span class="line"></span><br><span class="line">	memory@80000000 &#123;</span><br><span class="line">		device_type = &quot;memory&quot;;</span><br><span class="line">		reg = &lt;0x0 0x80000000 0x0 0x40000000&gt;;</span><br><span class="line">	&#125;;</span><br><span class="line"></span><br><span class="line">	cpus &#123;</span><br><span class="line">		#address-cells = &lt;0x1&gt;;</span><br><span class="line">		#size-cells = &lt;0x0&gt;;</span><br><span class="line">		timebase-frequency = &lt;0x989680&gt;;</span><br><span class="line"></span><br><span class="line">		cpu0: cpu@0 &#123;</span><br><span class="line">			phandle = &lt;0xf&gt;;</span><br><span class="line">			device_type = &quot;cpu&quot;;</span><br><span class="line">			reg = &lt;0x0&gt;;</span><br><span class="line">			status = &quot;okay&quot;;</span><br><span class="line">			compatible = &quot;riscv&quot;;</span><br><span class="line">			riscv,isa = &quot;rv64imafdcsu&quot;;</span><br><span class="line">			mmu-type = &quot;riscv,sv48&quot;;</span><br><span class="line"></span><br><span class="line">			interrupt-controller &#123;</span><br><span class="line">				#interrupt-cells = &lt;0x1&gt;;</span><br><span class="line">				interrupt-controller;</span><br><span class="line">				compatible = &quot;riscv,cpu-intc&quot;;</span><br><span class="line">				phandle = &lt;0x10&gt;;</span><br><span class="line">			&#125;;</span><br><span class="line">		&#125;;</span><br><span class="line"></span><br><span class="line">		cpu1: cpu@1 &#123;</span><br><span class="line">			phandle = &lt;0xd&gt;;</span><br><span class="line">			device_type = &quot;cpu&quot;;</span><br><span class="line">			reg = &lt;0x1&gt;;</span><br><span class="line">			status = &quot;okay&quot;;</span><br><span class="line">			compatible = &quot;riscv&quot;;</span><br><span class="line">			riscv,isa = &quot;rv64imafdcsu&quot;;</span><br><span class="line">			mmu-type = &quot;riscv,sv48&quot;;</span><br><span class="line"></span><br><span class="line">			interrupt-controller &#123;</span><br><span class="line">				#interrupt-cells = &lt;0x1&gt;;</span><br><span class="line">				interrupt-controller;</span><br><span class="line">				compatible = &quot;riscv,cpu-intc&quot;;</span><br><span class="line">				phandle = &lt;0xe&gt;;</span><br><span class="line">			&#125;;</span><br><span class="line">		&#125;;</span><br><span class="line"></span><br><span class="line">		cpu2: cpu@2 &#123;</span><br><span class="line">			phandle = &lt;0xb&gt;;</span><br><span class="line">			device_type = &quot;cpu&quot;;</span><br><span class="line">			reg = &lt;0x2&gt;;</span><br><span class="line">			status = &quot;okay&quot;;</span><br><span class="line">			compatible = &quot;riscv&quot;;</span><br><span class="line">			riscv,isa = &quot;rv64imafdcsu&quot;;</span><br><span class="line">			mmu-type = &quot;riscv,sv48&quot;;</span><br><span class="line"></span><br><span class="line">			interrupt-controller &#123;</span><br><span class="line">				#interrupt-cells = &lt;0x1&gt;;</span><br><span class="line">				interrupt-controller;</span><br><span class="line">				compatible = &quot;riscv,cpu-intc&quot;;</span><br><span class="line">				phandle = &lt;0xc&gt;;</span><br><span class="line">			&#125;;</span><br><span class="line">		&#125;;</span><br><span class="line"></span><br><span class="line">		cpu3: cpu@3 &#123;</span><br><span class="line">			phandle = &lt;0x9&gt;;</span><br><span class="line">			device_type = &quot;cpu&quot;;</span><br><span class="line">			reg = &lt;0x3&gt;;</span><br><span class="line">			status = &quot;okay&quot;;</span><br><span class="line">			compatible = &quot;riscv&quot;;</span><br><span class="line">			riscv,isa = &quot;rv64imafdcsu&quot;;</span><br><span class="line">			mmu-type = &quot;riscv,sv48&quot;;</span><br><span class="line"></span><br><span class="line">			interrupt-controller &#123;</span><br><span class="line">				#interrupt-cells = &lt;0x1&gt;;</span><br><span class="line">				interrupt-controller;</span><br><span class="line">				compatible = &quot;riscv,cpu-intc&quot;;</span><br><span class="line">				phandle = &lt;0xa&gt;;</span><br><span class="line">			&#125;;</span><br><span class="line">		&#125;;</span><br><span class="line"></span><br><span class="line">		cpu4: cpu@4 &#123;</span><br><span class="line">			phandle = &lt;0x7&gt;;</span><br><span class="line">			device_type = &quot;cpu&quot;;</span><br><span class="line">			reg = &lt;0x4&gt;;</span><br><span class="line">			status = &quot;okay&quot;;</span><br><span class="line">			compatible = &quot;riscv&quot;;</span><br><span class="line">			riscv,isa = &quot;rv64imafdcsu&quot;;</span><br><span class="line">			mmu-type = &quot;riscv,sv48&quot;;</span><br><span class="line"></span><br><span class="line">			interrupt-controller &#123;</span><br><span class="line">				#interrupt-cells = &lt;0x1&gt;;</span><br><span class="line">				interrupt-controller;</span><br><span class="line">				compatible = &quot;riscv,cpu-intc&quot;;</span><br><span class="line">				phandle = &lt;0x8&gt;;</span><br><span class="line">			&#125;;</span><br><span class="line">		&#125;;</span><br><span class="line"></span><br><span class="line">		cpu5: cpu@5 &#123;</span><br><span class="line">			phandle = &lt;0x5&gt;;</span><br><span class="line">			device_type = &quot;cpu&quot;;</span><br><span class="line">			reg = &lt;0x5&gt;;</span><br><span class="line">			status = &quot;okay&quot;;</span><br><span class="line">			compatible = &quot;riscv&quot;;</span><br><span class="line">			riscv,isa = &quot;rv64imafdcsu&quot;;</span><br><span class="line">			mmu-type = &quot;riscv,sv48&quot;;</span><br><span class="line"></span><br><span class="line">			interrupt-controller &#123;</span><br><span class="line">				#interrupt-cells = &lt;0x1&gt;;</span><br><span class="line">				interrupt-controller;</span><br><span class="line">				compatible = &quot;riscv,cpu-intc&quot;;</span><br><span class="line">				phandle = &lt;0x6&gt;;</span><br><span class="line">			&#125;;</span><br><span class="line">		&#125;;</span><br><span class="line"></span><br><span class="line">		cpu6: cpu@6 &#123;</span><br><span class="line">			phandle = &lt;0x3&gt;;</span><br><span class="line">			device_type = &quot;cpu&quot;;</span><br><span class="line">			reg = &lt;0x6&gt;;</span><br><span class="line">			status = &quot;okay&quot;;</span><br><span class="line">			compatible = &quot;riscv&quot;;</span><br><span class="line">			riscv,isa = &quot;rv64imafdcsu&quot;;</span><br><span class="line">			mmu-type = &quot;riscv,sv48&quot;;</span><br><span class="line"></span><br><span class="line">			interrupt-controller &#123;</span><br><span class="line">				#interrupt-cells = &lt;0x1&gt;;</span><br><span class="line">				interrupt-controller;</span><br><span class="line">				compatible = &quot;riscv,cpu-intc&quot;;</span><br><span class="line">				phandle = &lt;0x4&gt;;</span><br><span class="line">			&#125;;</span><br><span class="line">		&#125;;</span><br><span class="line"></span><br><span class="line">		cpu7: cpu@7 &#123;</span><br><span class="line">			phandle = &lt;0x1&gt;;</span><br><span class="line">			device_type = &quot;cpu&quot;;</span><br><span class="line">			reg = &lt;0x7&gt;;</span><br><span class="line">			status = &quot;okay&quot;;</span><br><span class="line">			compatible = &quot;riscv&quot;;</span><br><span class="line">			riscv,isa = &quot;rv64imafdcsu&quot;;</span><br><span class="line">			mmu-type = &quot;riscv,sv48&quot;;</span><br><span class="line"></span><br><span class="line">			interrupt-controller &#123;</span><br><span class="line">				#interrupt-cells = &lt;0x1&gt;;</span><br><span class="line">				interrupt-controller;</span><br><span class="line">				compatible = &quot;riscv,cpu-intc&quot;;</span><br><span class="line">				phandle = &lt;0x2&gt;;</span><br><span class="line">			&#125;;</span><br><span class="line">		&#125;;</span><br><span class="line"></span><br><span class="line">		cpu-map &#123;</span><br><span class="line"></span><br><span class="line">			cluster0 &#123;</span><br><span class="line"></span><br><span class="line">				core0 &#123;</span><br><span class="line">					cpu = &lt;0xf&gt;;</span><br><span class="line">				&#125;;</span><br><span class="line"></span><br><span class="line">				core1 &#123;</span><br><span class="line">					cpu = &lt;0xd&gt;;</span><br><span class="line">				&#125;;</span><br><span class="line"></span><br><span class="line">				core2 &#123;</span><br><span class="line">					cpu = &lt;0xb&gt;;</span><br><span class="line">				&#125;;</span><br><span class="line"></span><br><span class="line">				core3 &#123;</span><br><span class="line">					cpu = &lt;0x9&gt;;</span><br><span class="line">				&#125;;</span><br><span class="line"></span><br><span class="line">				core4 &#123;</span><br><span class="line">					cpu = &lt;0x7&gt;;</span><br><span class="line">				&#125;;</span><br><span class="line"></span><br><span class="line">				core5 &#123;</span><br><span class="line">					cpu = &lt;0x5&gt;;</span><br><span class="line">				&#125;;</span><br><span class="line"></span><br><span class="line">				core6 &#123;</span><br><span class="line">					cpu = &lt;0x3&gt;;</span><br><span class="line">				&#125;;</span><br><span class="line"></span><br><span class="line">				core7 &#123;</span><br><span class="line">					cpu = &lt;0x1&gt;;</span><br><span class="line">				&#125;;</span><br><span class="line">			&#125;;</span><br><span class="line">		&#125;;</span><br><span class="line">	&#125;;</span><br><span class="line"></span><br><span class="line">	soc &#123;</span><br><span class="line">		#address-cells = &lt;0x2&gt;;</span><br><span class="line">		#size-cells = &lt;0x2&gt;;</span><br><span class="line">		compatible = &quot;simple-bus&quot;;</span><br><span class="line">		ranges;</span><br><span class="line"></span><br><span class="line">		uart0: uart0@10000000 &#123;</span><br><span class="line">			interrupts = &lt;0xa&gt;;</span><br><span class="line">			interrupt-parent = &lt;0x11&gt;;</span><br><span class="line">			clock-frequency = &lt;0x384000&gt;;</span><br><span class="line">			reg = &lt;0x0 0x10000000 0x0 0x1000&gt;;</span><br><span class="line">			compatible = &quot;ns16550a&quot;;</span><br><span class="line">		&#125;;</span><br><span class="line"></span><br><span class="line">		uart1: uart1@10001000 &#123;</span><br><span class="line">			interrupts = &lt;0xa&gt;;</span><br><span class="line">			interrupt-parent = &lt;0x11&gt;;</span><br><span class="line">			clock-frequency = &lt;0x384000&gt;;</span><br><span class="line">			reg = &lt;0x0 0x10001000 0x0 0x1000&gt;;</span><br><span class="line">			compatible = &quot;ns16550a&quot;;</span><br><span class="line">		&#125;;</span><br><span class="line"></span><br><span class="line">        uart2: uart2@10002000 &#123;</span><br><span class="line">			interrupts = &lt;0xa&gt;;</span><br><span class="line">			interrupt-parent = &lt;0x11&gt;;</span><br><span class="line">			clock-frequency = &lt;0x384000&gt;;</span><br><span class="line">			reg = &lt;0x0 0x10002000 0x0 0x1000&gt;;</span><br><span class="line">			compatible = &quot;ns16550a&quot;;</span><br><span class="line">		&#125;;</span><br><span class="line"></span><br><span class="line">		plic@c000000 &#123;</span><br><span class="line">			phandle = &lt;0x11&gt;;</span><br><span class="line">			riscv,ndev = &lt;0x35&gt;;</span><br><span class="line">			reg = &lt;0x0 0xc000000 0x0 0x210000&gt;;</span><br><span class="line">			interrupts-extended = &lt;0x10 0xb 0x10 0x9 0xe 0xb 0xe 0x9 0xc 0xb 0xc 0x9 0xa 0xb 0xa 0x9 0x8 0xb 0x8 0x9 0x6 0xb 0x6 0x9 0x4 0xb 0x4 0x9 0x2 0xb 0x2 0x9&gt;;</span><br><span class="line">			interrupt-controller;</span><br><span class="line">			compatible = &quot;riscv,plic0&quot;;</span><br><span class="line">			#interrupt-cells = &lt;0x1&gt;;</span><br><span class="line">			#address-cells = &lt;0x0&gt;;</span><br><span class="line">		&#125;;</span><br><span class="line"></span><br><span class="line">		clint@2000000 &#123;</span><br><span class="line">			interrupts-extended = &lt;0x10 0x3 0x10 0x7 0xe 0x3 0xe 0x7 0xc 0x3 0xc 0x7 0xa 0x3 0xa 0x7 0x8 0x3 0x8 0x7 0x6 0x3 0x6 0x7 0x4 0x3 0x4 0x7 0x2 0x3 0x2 0x7&gt;;</span><br><span class="line">			reg = &lt;0x0 0x2000000 0x0 0x10000&gt;;</span><br><span class="line">			compatible = &quot;riscv,clint0&quot;;</span><br><span class="line">		&#125;;</span><br><span class="line">	&#125;;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>



<h1 id="3-start-s重新编写"><a href="#3-start-s重新编写" class="headerlink" title="3.start.s重新编写"></a>3.start.s重新编写</h1><p>start.s需要重新编写用于引导加载opensbi固件以及设备树，然后跳转到DRAM执行opensbi</p>
<blockquote>
<p>boot&#x2F;start.s</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line">	.macro loop,cunt</span><br><span class="line">    li		t1,	0xffff</span><br><span class="line">    li		t2,	\cunt</span><br><span class="line">1:</span><br><span class="line">	nop</span><br><span class="line">	addi    t1, t1, -1</span><br><span class="line">	bne		t1, x0, 1b</span><br><span class="line">    li		t1,	0xffff</span><br><span class="line">	addi    t2, t2, -1</span><br><span class="line">	bne		t2, x0, 1b</span><br><span class="line">	.endm</span><br><span class="line"></span><br><span class="line">	.macro load_data,_src_start,_dst_start,_dst_end</span><br><span class="line">	bgeu	\_dst_start, \_dst_end, 2f</span><br><span class="line">1:</span><br><span class="line">	lw      t0, (\_src_start)</span><br><span class="line">	sw      t0, (\_dst_start)</span><br><span class="line">	addi    \_src_start, \_src_start, 4</span><br><span class="line">	addi    \_dst_start, \_dst_start, 4</span><br><span class="line">	bltu    \_dst_start, \_dst_end, 1b</span><br><span class="line">2:</span><br><span class="line">	.endm</span><br><span class="line"></span><br><span class="line">	.section .text</span><br><span class="line">	.globl _start</span><br><span class="line">	.type _start,@function</span><br><span class="line"></span><br><span class="line">_start:</span><br><span class="line">	//load opensbi_fw.bin </span><br><span class="line">	//[0x20200000:0x20400000] --&gt; [0x80000000:0x80200000]</span><br><span class="line">    li		a0,	0x202</span><br><span class="line">	slli	a0,	a0, 20      //a0 = 0x20200000</span><br><span class="line">    li		a1,	0x800</span><br><span class="line">	slli	a1,	a1, 20      //a1 = 0x80000000</span><br><span class="line">    li		a2,	0x802</span><br><span class="line">	slli	a2,	a2, 20      //a2 = 0x80200000</span><br><span class="line">	load_data a0,a1,a2</span><br><span class="line"></span><br><span class="line">	//load qemu_sbi.dtb</span><br><span class="line">	//[0x20080000:0x20100000] --&gt; [0x82200000:0x82280000]</span><br><span class="line">    li		a0,	0x2008</span><br><span class="line">	slli	a0,	a0, 16       //a0 = 0x20080000</span><br><span class="line">    li		a1,	0x822</span><br><span class="line">	slli	a1,	a1, 20       //a1 = 0x82200000</span><br><span class="line">    li		a2,	0x8228</span><br><span class="line">	slli	a2,	a2, 16       //a2 = 0x82280000</span><br><span class="line">	load_data a0,a1,a2</span><br><span class="line"></span><br><span class="line">    csrr    a0, mhartid</span><br><span class="line">    li		t0,	0x0     </span><br><span class="line">	beq		a0, t0, _no_wait</span><br><span class="line">	loop	0x1000</span><br><span class="line">_no_wait:</span><br><span class="line">    li		a1,	0x822</span><br><span class="line">	slli	a1,	a1, 20       //a1 = 0x82200000</span><br><span class="line">    li	    t0,	0x800</span><br><span class="line">	slli	t0,	t0, 20       //t0 = 0x80000000</span><br><span class="line">    jr      t0</span><br><span class="line"></span><br><span class="line">    .end</span><br></pre></td></tr></table></figure>



<p><strong>解析：</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">	.macro loop,cunt</span><br><span class="line">    li		t1,	0xffff  # 将0xffff 加载到寄存器他</span><br><span class="line">    li		t2,	\cunt   # 将参数 cunt 的值加载到寄存器 t2 </span><br><span class="line">1:</span><br><span class="line">	nop					# 空操作</span><br><span class="line">	addi    t1, t1, -1  # t1 减 1</span><br><span class="line">	bne		t1, x0, 1b	# x0是riscv的零寄存器，值始终为0。如果 t1 不等于零，跳回标签 1，继续循环。 ben（非等）</span><br><span class="line">    li		t1,	0xffff	# 重置</span><br><span class="line">	addi    t2, t2, -1 	# t2 寄存器 减一</span><br><span class="line">	bne		t2, x0, 1b</span><br><span class="line">	.endm</span><br></pre></td></tr></table></figure>

<ul>
<li><code>loop</code>宏，这里定义了一个双重循环，用于执行一个固定次数的空操作。宏接收一个参数 <code>cunt</code> 表示外层循环数 t1是内存循环数</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">.macro load_data,_src_start,_dst_start,_dst_end</span><br><span class="line">	bgeu	\_dst_start, \_dst_end, 2f  		# 如果 _dst_start &gt;= _dst_end，跳到标签 2</span><br><span class="line">1:</span><br><span class="line">	lw      t0, (\_src_start)					# 从 _src_start 加载一个字到 t0 lw load word</span><br><span class="line">	sw      t0, (\_dst_start)					# 将 t0 存储到 _dst_start</span><br><span class="line">	addi    \_src_start, \_src_start, 4			# 将 _src_start 增加 4</span><br><span class="line">	addi    \_dst_start, \_dst_start, 4			# 将 _dst_start 增加 4</span><br><span class="line">	bltu    \_dst_start, \_dst_end, 1b			# 如果 _dst_start &lt; _dst_end，跳回标签 1</span><br><span class="line">2:</span><br><span class="line">	.endm</span><br></pre></td></tr></table></figure>

<p><code>load_data</code>宏，定义了一个从源地址加载数据到目标地址的循环，直到目标地址到达结束地址。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">.section .text</span><br><span class="line">.globl _start</span><br><span class="line">.type _start, @function</span><br></pre></td></tr></table></figure>

<ul>
<li><code>.section .text</code>：定义代码段（.text 段），用于存放可执行代码。</li>
<li><code>.globl _start</code>：声明 <code>_start</code> 标签为全局符号，使其在链接时可见。</li>
<li><code>.type _start, @function</code>：指定 <code>_start</code> 为函数类型</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">//load opensbi_fw.bin </span><br><span class="line">//[0x20200000:0x20400000] --&gt; [0x80000000:0x80200000]</span><br><span class="line">   li		a0,	0x202</span><br><span class="line">slli	a0,	a0, 20      //a0 = 0x20200000 左移20位</span><br><span class="line">   li		a1,	0x800</span><br><span class="line">slli	a1,	a1, 20      //a1 = 0x80000000</span><br><span class="line">   li		a2,	0x802</span><br><span class="line">slli	a2,	a2, 20      //a2 = 0x80200000</span><br><span class="line">load_data a0,a1,a2</span><br></pre></td></tr></table></figure>

<ul>
<li>加载opensbi固件</li>
<li><strong>load_data a0, a1, a2</strong>: 调用宏 <code>load_data</code>，将从 <code>0x20200000</code> 到 <code>0x20400000</code> 的数据复制到 <code>0x80000000</code> 到 <code>0x80200000</code>。</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">//load qemu_sbi.dtb</span><br><span class="line">//[0x20080000:0x20100000] --&gt; [0x82200000:0x82280000]</span><br><span class="line">   li		a0,	0x2008</span><br><span class="line">slli	a0,	a0, 16       //a0 = 0x20080000</span><br><span class="line">   li		a1,	0x822</span><br><span class="line">slli	a1,	a1, 20       //a1 = 0x82200000</span><br><span class="line">   li		a2,	0x8228</span><br><span class="line">slli	a2,	a2, 16       //a2 = 0x82280000 左移16位</span><br><span class="line">load_data a0,a1,a2</span><br></pre></td></tr></table></figure>

<ul>
<li>加载qemu sbi 设备树</li>
<li><strong>load_data a0, a1, a2</strong>: 调用宏 <code>load_data</code>，将从 <code>0x20080000</code> 到 <code>0x20100000</code> 的数据复制到 <code>0x82200000</code> 到 <code>0x82280000</code>。</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">	csrr    a0, mhartid</span><br><span class="line">    li		t0,	0x0     </span><br><span class="line">	beq		a0, t0, _no_wait</span><br><span class="line">	loop	0x1000</span><br><span class="line">_no_wait:</span><br><span class="line">    li		a1,	0x822</span><br><span class="line">	slli	a1,	a1, 20       //a1 = 0x82200000</span><br><span class="line">    li	    t0,	0x800</span><br><span class="line">	slli	t0,	t0, 20       //t0 = 0x80000000</span><br><span class="line">    jr      t0</span><br></pre></td></tr></table></figure>

<ul>
<li><p>检查当前hart，</p>
</li>
<li><p><strong>csrr a0, mhartid</strong>: 读取当前 hart ID（硬件线程 ID）到寄存器 <code>a0</code>。</p>
<p><strong>li t0, 0x0</strong>: 将 <code>0</code> 加载到寄存器 <code>t0</code>。</p>
<p><strong>beq a0, t0, _no_wait</strong>: 如果 <code>a0</code> 等于 <code>t0</code>（即当前 hart ID 为 0），跳转到 <code>_no_wait</code> 标签。</p>
<p><strong>loop 0x1000</strong>: 否则，执行一个循环（定义在上面的 <code>loop</code> 宏中），大约等待一段时间。</p>
</li>
<li><p>nowait</p>
</li>
<li><p><strong>li a1, 0x822</strong>: 将 <code>0x822</code> 加载到寄存器 <code>a1</code> 中。</p>
<p><strong>slli a1, a1, 20</strong>: 将 <code>a1</code> 左移 20 位，使其值变为 <code>0x82200000</code>。 —设备树</p>
<p><strong>li t0, 0x800</strong>: 将 <code>0x800</code> 加载到寄存器 <code>t0</code> 中。</p>
<p><strong>slli t0, t0, 20</strong>: 将 <code>t0</code> 左移 20 位，使其值变为 <code>0x80000000</code>。 —opensbi</p>
<p><strong>jr t0</strong>: 跳转到 <code>t0</code>（即 <code>0x80000000</code>）处，开始执行新程序。 —opensbi</p>
</li>
</ul>
<p><strong>总结，这段代码实现了以下功能：</strong></p>
<ol>
<li>将 OpenSBI 固件从 <code>0x20200000</code> 复制到 <code>0x80000000</code>。</li>
<li>将 QEMU SBI 设备树从 <code>0x20080000</code> 复制到 <code>0x82200000</code>。</li>
<li>检查当前 hart ID，如果不是 0，则执行一个等待循环。</li>
<li>跳转到 <code>0x80000000</code> 处，执行新的程序。</li>
</ol>
<h1 id="4-build-sh和-run-sh修改"><a href="#4-build-sh和-run-sh修改" class="headerlink" title="4.build.sh和 run.sh修改"></a>4.build.sh和 run.sh修改</h1><blockquote>
<p>build.sh</p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">---------------------------编译opensbi-----------------------------</span></span><br><span class="line">echo &quot;------------------------- 编译opensbi-----------------------------&quot;</span><br><span class="line">if [ ! -d &quot;$SHELL_FOLDER/output/opensbi&quot; ]; then  </span><br><span class="line">mkdir $SHELL_FOLDER/output/opensbi</span><br><span class="line">fi  </span><br><span class="line">cd $SHELL_FOLDER/opensbi-1.2</span><br><span class="line">make CROSS_COMPILE=$CROSS_PREFIX- PLATFORM=quard_star</span><br><span class="line">cp -r $SHELL_FOLDER/opensbi-1.2/build/platform/quard_star/firmware/*.bin $SHELL_FOLDER/output/opensbi/</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">生成sbi.dtb</span></span><br><span class="line">cd $SHELL_FOLDER/dts</span><br><span class="line">dtc -I dts -O dtb -o $SHELL_FOLDER/output/opensbi/quard_star_sbi.dtb quard_star_sbi.dts</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">合成firmware固件</span></span><br><span class="line">if [ ! -d &quot;$SHELL_FOLDER/output/fw&quot; ]; then  </span><br><span class="line">mkdir $SHELL_FOLDER/output/fw</span><br><span class="line">fi  </span><br><span class="line">cd $SHELL_FOLDER/output/fw</span><br><span class="line">rm -rf fw.bin</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">填充 32K的0</span></span><br><span class="line">dd of=fw.bin bs=1k count=32k if=/dev/zero   </span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"><span class="comment"># 写入 lowlevel_fw.bin 偏移量地址为 0</span></span></span><br><span class="line">dd of=fw.bin bs=1k conv=notrunc seek=0 if=$SHELL_FOLDER/output/lowlevelboot/lowlevel_fw.bin</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">写入 quard_star_sbi.dtb 地址偏移量为 512K，因此 fdt的地址偏移量为 0x80000</span></span><br><span class="line">dd of=fw.bin bs=1k conv=notrunc seek=512 if=$SHELL_FOLDER/output/opensbi/quard_star_sbi.dtb</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">写入 fw_jump.bin 地址偏移量为 2K*1K= 0x2000000，因此 fw_jump.bin的地址偏移量为  0x2000000</span></span><br><span class="line">dd of=fw.bin bs=1k conv=notrunc seek=2k if=$SHELL_FOLDER/output/opensbi/fw_jump.bin</span><br></pre></td></tr></table></figure>

<p><strong>操作：</strong></p>
<ol>
<li>首先编译了opensbi，并且指定了板</li>
<li>编译生成设备树dtb</li>
<li>合成固件</li>
</ol>
<ul>
<li>根据dd命令的使用可以看见将<code>quard_star_sbi.dtb</code>写入到了偏移地址为<code>0x80000</code>的地方，用于这个固件会被加载到<code>flash</code>处，所以设备树的地址为：<code>0x20080000 </code> —- <strong>对应了<code>start.s</code>文件加载设备树的地址</strong></li>
<li><code>fw_jump.bin</code> 地址偏移量为 <code>2K*1K= 0x2000000</code>，因此 <code>fw_jump.bin</code>的地址偏移量为 <code>0x2000000</code>，同理 这个固件会被加载到<code>flash</code>，所以<code>opensbi</code>固件的地址为：<code>0x20200000</code>   <strong>—对应<code>start.s</code> 加载 <code>opensbi</code>的位置</strong></li>
<li><code>lowlevel_fw.bin</code> 偏移量地址为 0，因此<code>lowlevel_fw.bin</code> 的地址为：<code>0x20000000</code></li>
<li><code>dd of=fw.bin bs=1k count=32k if=/dev/zero </code>来填充填充 32K的0，这是<code>qemu</code>使用<code>-drive</code>加载的固件的大小要大于等于定义的<code>flash</code>的大小，不然会报错。</li>
</ul>
<p><strong>注意</strong></p>
<p>现在固件包含三个内容：</p>
<ol>
<li>首先是起始<code>0x20000000</code>的<code>lowlevel_fw.bin</code><ol>
<li>lowlevel的作用是将opensbi 以及设备树文件从flash中 加载到 DRAM（0x80000000），然后跳转到DRAM执行</li>
</ol>
</li>
<li>然后是<code>0x20080000</code>地址处的<code>dtb</code>文件</li>
<li>接下来是<code>0x20200000</code>处的<code>opensbi</code>程序</li>
</ol>
<blockquote>
<p>run.sh</p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">SHELL_FOLDER=$(cd &quot;$(dirname &quot;$0&quot;)&quot;;pwd)</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">$</span><span class="language-bash">SHELL_FOLDER/output/qemu/bin/qemu-system-riscv64 \</span></span><br><span class="line"><span class="language-bash">-M quard-star \</span></span><br><span class="line"><span class="language-bash">-m 1G \</span></span><br><span class="line"><span class="language-bash">-smp 8 \</span></span><br><span class="line"><span class="language-bash">-bios none \</span></span><br><span class="line"><span class="language-bash">-drive <span class="keyword">if</span>=pflash,bus=0,unit=0,format=raw,file=<span class="variable">$SHELL_FOLDER</span>/output/fw/fw.bin \</span></span><br><span class="line"><span class="language-bash">-d in_asm -D qemu.log \</span></span><br><span class="line"><span class="language-bash">-nographic --parallel none \</span></span><br></pre></td></tr></table></figure>

<p>这里添加了一个<code>qemu.log</code>会生成汇编代码，可以根据这个log来查看固件是否有正确的加载、跳转。</p>
<p>执行<code>build.sh run.sh</code></p>
<p>报错<code>./build.sh: 45: dtc: not found</code></p>
<p>执行：<code>sudo apt-get install device-tree-complier</code></p>
<blockquote>
<p>还需要修改</p>
<p>quard_star.c   把DRAM内存扩大</p>
</blockquote>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[QUARD_STAR_DRAM]  = &#123; <span class="number">0x80000000</span>,    <span class="number">0x40000000</span> &#125;,</span><br></pre></td></tr></table></figure>



<p><strong>显示结果</strong></p>
<p><img src="/2024/06/08/riscv-5-%E8%AE%BE%E5%A4%87%E6%A0%91/image-20240609181609447.png" alt="image-20240609181609447"></p>
<h1 id="5-内存布局"><a href="#5-内存布局" class="headerlink" title="5.内存布局"></a>5.内存布局</h1><ol>
<li><code>rom</code>中先从（<code>fw_dynamic_info</code>这个结构体指示了<code>flash</code>的起始地址 在哪找到它）<code>flash</code>记载<code>lowlevel</code>，然后跳转执行<code>flash</code>   (<code>flash</code>中的固件是直接 <code>drive</code>注入的)</li>
<li><code>flash</code>中存放l<code>owerlevel.bin</code>，<code>opensbi</code>固件，设备树固件</li>
<li>将<code>opensbi</code>，设备树固件加载到<code>DRAM</code> 并跳转执行</li>
</ol>
<p><img src="/2024/06/08/riscv-5-%E8%AE%BE%E5%A4%87%E6%A0%91/image-20240609182439432.png" alt="image-20240609182439432"></p>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="http://liangzhouzz.github.io">liangzhou</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="http://liangzhouzz.github.io/2024/06/08/riscv-5-%E8%AE%BE%E5%A4%87%E6%A0%91/">http://liangzhouzz.github.io/2024/06/08/riscv-5-%E8%AE%BE%E5%A4%87%E6%A0%91/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="http://liangzhouzz.github.io" target="_blank">Sifanのblog</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/">操作系统</a><a class="post-meta__tags" href="/tags/riscv%EF%BC%8Cqemu/">riscv，qemu</a></div><div class="post_share"><div class="social-share" data-image="/img/duck.jpg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/2024/06/09/riscv-6-domain%E6%9C%BA%E5%88%B6/" title="riscv-6-domain"><div class="cover" style="background: var(--default-bg-color)"></div><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">riscv-6-domain</div></div></a></div><div class="next-post pull-right"><a href="/2024/06/06/riscv-4-opensbi/" title="riscv-4-opensbi"><div class="cover" style="background: var(--default-bg-color)"></div><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">riscv-4-opensbi</div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span>相关推荐</span></div><div class="relatedPosts-list"><div><a href="/2024/03/25/%E5%9F%BA%E4%BA%8Eqemu-riscv%E6%9E%84%E4%BB%B6%E5%B5%8C%E5%85%A5%E5%BC%8F%E7%B3%BB%E7%BB%9F/" title="基于qemu-riscv构建嵌入式系统"><div class="cover" style="background: var(--default-bg-color)"></div><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2024-03-25</div><div class="title">基于qemu-riscv构建嵌入式系统</div></div></a></div><div><a href="/2024/06/02/qemu-riscv-add-flash-itr-gpio/" title="riscv-2-flash-itr-gpio"><div class="cover" style="background: var(--default-bg-color)"></div><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2024-06-02</div><div class="title">riscv-2-flash-itr-gpio</div></div></a></div><div><a href="/2024/06/04/riscv-3-%E6%B5%8B%E8%AF%95%E4%B8%B2%E5%8F%A3%E6%89%93%E5%8D%B0/" title="riscv-3-测试串口打印"><div class="cover" style="background: var(--default-bg-color)"></div><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2024-06-04</div><div class="title">riscv-3-测试串口打印</div></div></a></div><div><a href="/2024/06/06/riscv-4-opensbi/" title="riscv-4-opensbi"><div class="cover" style="background: var(--default-bg-color)"></div><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2024-06-06</div><div class="title">riscv-4-opensbi</div></div></a></div><div><a href="/2024/06/09/riscv-6-domain%E6%9C%BA%E5%88%B6/" title="riscv-6-domain"><div class="cover" style="background: var(--default-bg-color)"></div><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2024-06-09</div><div class="title">riscv-6-domain</div></div></a></div><div><a href="/2024/06/10/riscv-7-opensbi%E6%8E%A7%E5%88%B6%E5%8F%B0%E8%BE%93%E5%87%BA%E4%BB%A5%E5%8F%8A%E6%89%8B%E5%86%99%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/" title="riscv-7-opensbi控制台输出以及手写操作系统"><div class="cover" style="background: var(--default-bg-color)"></div><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2024-06-10</div><div class="title">riscv-7-opensbi控制台输出以及手写操作系统</div></div></a></div></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="is-center"><div class="avatar-img"><img src="/img/duck.jpg" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info__name">liangzhou</div><div class="author-info__description">要努力，不要急！</div></div><div class="card-info-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">35</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">24</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">7</div></a></div><a id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/liangzhouzz/"><i class="fab fa-github"></i><span>Follow Me</span></a></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>公告</span></div><div class="announcement_content">This is my Blog!</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#1-%E8%AE%BE%E5%A4%87%E6%A0%91%E4%BB%8B%E7%BB%8D"><span class="toc-number">1.</span> <span class="toc-text">1.设备树介绍</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#2-%E7%BC%96%E5%86%99quard-star%E7%9A%84%E8%AE%BE%E5%A4%87%E6%A0%91%E6%96%87%E4%BB%B6"><span class="toc-number">2.</span> <span class="toc-text">2.编写quard_star的设备树文件</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#3-start-s%E9%87%8D%E6%96%B0%E7%BC%96%E5%86%99"><span class="toc-number">3.</span> <span class="toc-text">3.start.s重新编写</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#4-build-sh%E5%92%8C-run-sh%E4%BF%AE%E6%94%B9"><span class="toc-number">4.</span> <span class="toc-text">4.build.sh和 run.sh修改</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#5-%E5%86%85%E5%AD%98%E5%B8%83%E5%B1%80"><span class="toc-number">5.</span> <span class="toc-text">5.内存布局</span></a></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2024/06/24/riscv-15-%E5%BA%94%E7%94%A8%E7%A8%8B%E5%BA%8F%E7%9A%84%E5%8A%A0%E8%BD%BD/" title="riscv-15-应用程序的加载">riscv-15-应用程序的加载</a><time datetime="2024-06-24T13:27:07.000Z" title="发表于 2024-06-24 21:27:07">2024-06-24</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2024/06/21/riscv-14-%E5%86%85%E5%AD%98%E6%98%A0%E5%B0%84%E6%9C%BA%E5%88%B6%E5%AE%9E%E7%8E%B0/" title="riscv-14-内存映射机制实现">riscv-14-内存映射机制实现</a><time datetime="2024-06-21T09:02:42.000Z" title="发表于 2024-06-21 17:02:42">2024-06-21</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2024/06/20/riscv-13-%E7%89%A9%E7%90%86%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86%E4%B8%8E%E5%88%86%E9%A1%B5%E6%9C%BA%E5%88%B6/" title="riscv-13-物理内存管理与分页机制介绍14">riscv-13-物理内存管理与分页机制介绍14</a><time datetime="2024-06-20T07:46:46.000Z" title="发表于 2024-06-20 15:46:46">2024-06-20</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2024/06/19/riscv-12-printf%E5%AE%9E%E7%8E%B0/" title="riscv-12-printf实现">riscv-12-printf实现</a><time datetime="2024-06-19T11:56:57.000Z" title="发表于 2024-06-19 19:56:57">2024-06-19</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2024/06/18/riscv-11-%E5%88%86%E6%97%B6%E5%A4%9A%E4%BB%BB%E5%8A%A1%E4%B8%8E%E6%8A%A2%E5%8D%A0%E5%BC%8F%E8%B0%83%E5%BA%A6%E7%AD%96%E7%95%A5%E5%AE%9E%E7%8E%B0/" title="riscv-11-分时多任务与抢占式调度策略实现">riscv-11-分时多任务与抢占式调度策略实现</a><time datetime="2024-06-18T13:33:34.000Z" title="发表于 2024-06-18 21:33:34">2024-06-18</time></div></div></div></div></div></div></main><footer id="footer" style="background-image: url('/img/footer.jpg')"><div id="footer-wrap"><div class="copyright">&copy;2023 - 2024 By liangzhou</div><div class="framework-info"><span>框架 </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>主题 </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div><div class="footer_custom_text">Hi!!!!!!</div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="回到顶部"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox/fancybox.umd.min.js"></script><script src="https://cdn.jsdelivr.net/npm/instant.page/instantpage.min.js" type="module"></script><div class="js-pjax"></div><canvas class="fireworks" mobile="false"></canvas><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/dist/fireworks.min.js"></script><script id="canvas_nest" defer="defer" color="0,0,255" opacity="0.7" zIndex="-1" count="99" mobile="false" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/dist/canvas-nest.min.js"></script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><div id="local-search"><div class="search-dialog"><nav class="search-nav"><span class="search-dialog-title">搜索</span><span id="loading-status"></span><button class="search-close-button"><i class="fas fa-times"></i></button></nav><div class="is-center" id="loading-database"><i class="fas fa-spinner fa-pulse"></i><span>  数据库加载中</span></div><div class="search-wrap"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="搜索文章" type="text"/></div></div><hr/><div class="no-result" id="local-search-results"></div><div id="local-search-stats-wrap"></div></div></div><div id="search-mask"></div><script src="/js/search/local-search.js"></script></div></div></body></html>